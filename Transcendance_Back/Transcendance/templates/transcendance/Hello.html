<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hello</title>
</head>

{% if user.is_authenticated %}
    <script>
        var currentUser = "{{ user.username }}";

        // Connexion WebSocket avec le serveur
        var socket = new WebSocket('wss://localhost/ws/system/');

        socket.onopen = function(event)
        {
            console.log('Connexion au system √©tablie');
            console.log('currentUser -->' + currentUser);
            send_get_friends_infos(currentUser);
            console.log('Demande d\'infos sur les amis envoy√©e');
        };

        socket.onclose = function(event)
        {
            console.log('Connexion au system ferm√©e');
        };
    </script>
{% endif %}


<body>
    <h1>Bienvenue sur le projet Transcendance</h1>
    <p>En cours de developpement</p>
    <p>
        {% if user.is_authenticated %}
            Bonjour {{ user.username }}
            <br></br>
            <img src="https://localhost/media/{{ user.avatar }}" alt="Profile picture" width="100" height="100">
        {% else %}
            Bonjour inconnu
        {% endif %}
    </p>

    {% if user.is_authenticated %}
        <a href="{% url 'logout' %}" class="btn btn-primary">Se deconnecter ‚ùå</a>
        <br></br>
        <a href="{% url 'chat-room' %}" class="btn btn-primary">Viens tchatter ici üí¨</a>
        <br></br>
        <a href="{% url 'update-account' %}" class="btn btn-primary">Modifier mon compte ‚ôªÔ∏è</a>
        <br></br>
        <div class="friends_requests"> </div>
        <div class="friends"> </div>

                
    {% else %}
        <a href="{% url 'signin' %}" class="btn btn-primary">S'inscrire üî•</a>
        <br></br>
        <a href="{% url 'login' %}" class="btn btn-primary">Se connecter ‚úÖ</a>
        <br></br>
        <a href="{% url 'redirect-to-provider' %}" class="btn btn-primary">Se connecter avec 4Ô∏è‚É£2Ô∏è‚É£</a>
    {% endif %}
</body>

{% if user.is_authenticated %}
    <script>

        //--------------------------------------------------------------------------------
        //                              GLOBAL VARIABLES
        //--------------------------------------------------------------------------------
        var friends = [];
        var friends_requests = [];
        var currentUser = "{{ user.username }}";

        //--------------------------------------------------------------------------------
        //                                  FUNCTIONS
        //--------------------------------------------------------------------------------

        // Demande d'informations sur les amis
        function send_get_friends_infos(currentUser)
        {
            var message = {
                'command': 'get_friends_infos',
                'user_to_add': currentUser
            }

            var messageJson = JSON.stringify(message);
            socket.send(messageJson);
        }

        // Envoie de l'acceptation en ami
        function send_accept_friend_request(original_user, user_to_add)
        {
            var message = {
                'command': 'accept_friend',
                'original_user': original_user,
                'user_to_add' : user_to_add,
            }

            var messageJson = JSON.stringify(message);
            socket.send(messageJson);
        }

        // Envoie du refus d'ami
        function send_reject_friend_request(original_user, user_to_add)
        {
            var message = {
                'command': 'reject_friend',
                'original_user': original_user,
                'user_to_add' : user_to_add,
            }

            var messageJson = JSON.stringify(message);
            socket.send(messageJson);
        }

        // Envoie de la demande de suppression d'ami
        function send_delete_friend_request(friend_to_delete, original_user)
        {
            var message = {
                'command': 'delete_friend',
                'friend_to_delete': friend_to_delete,
                'original_user' : original_user,
            }

            var messageJson = JSON.stringify(message);
            socket.send(messageJson);
        }

        //modification de la page si jamais l'ami a ete accepte ou refuse
        function clear_friend_request(original_user)
        {
    
            var friendRequestDiv = document.getElementById(original_user);
            console.log('le nom de la div a supprimer est -->' + friendRequestDiv.id);
            friendRequestDiv.remove();

            var friendsRequestsDiv = document.getElementsByClassName('friends_requests')[0];

            if (friendsRequestsDiv.childElementCount === 1)
                friendsRequestsDiv.firstElementChild.remove();
        }

        //modification de la page si jamais l'ami a ete supprime
        function clear_friend(friend_to_delete)
        {
            var friendDiv = document.getElementById(friend_to_delete);
            friendDiv.remove();
        }

        // Affichage des demandes d'amis quand on va sur la page
        function display_friends_requests()
        {
            if (friends_requests.length > 0)
                for (var i = 0; i < friends_requests.length; i++)
                    display_friend_request_div(friends_requests[i]);
        }

        // Affichage des amis
        function display_friends()
        {
            if (friends.length > 0)
                for (var i = 0; i < friends.length; i++)
                    display_friends_div(friends[i]);
        }

        // Affichage des amis
        function display_friends_div(original_user)
        {
            var friendsDiv = document.getElementsByClassName('friends')[0];
            if (friendsDiv.childElementCount === 0)
            {
                var friendsTitle = document.createElement('h2');
                friendsTitle.textContent = 'Liste d\'amis';
                friendsDiv.appendChild(friendsTitle);
            }

            var friendDiv = document.createElement('div');
            friendDiv.id = original_user;
            friendDiv.style.display = 'flex';
            friendsDiv.appendChild(friendDiv);

            var friendP = document.createElement('p');
            friendP.textContent = original_user;
            friendDiv.appendChild(friendP);

            var friendDeleteButton = document.createElement('button');
            friendDeleteButton.textContent = 'Supprimer';
            friendDiv.appendChild(friendDeleteButton);

            friendDeleteButton.addEventListener('click', function(event)
            {
                var friend_to_delete = event.target.parentElement.firstChild.textContent;
                send_delete_friend_request(friend_to_delete, currentUser);
            });

        }

        // Affichage des demandes d'amis
        function display_friend_request_div(original_user)
        {
            var friendsRequestsDiv = document.getElementsByClassName('friends_requests')[0];
            if (friendsRequestsDiv.childElementCount === 0)
            {
                var friendsRequestTitle = document.createElement('h2');
                friendsRequestTitle.textContent = 'Demandes d\'amis';
                friendsRequestsDiv.appendChild(friendsRequestTitle);
            }

            var child = friendsRequestsDiv.querySelector('#' + original_user);
            if (child && child.id === original_user)
                return;

            var friendRequestDiv = document.createElement('div');
            friendRequestDiv.id = original_user;
            friendRequestDiv.style.display = 'flex';
            friendsRequestsDiv.appendChild(friendRequestDiv);

            var friendRequestP = document.createElement('p');
            friendRequestP.textContent = original_user;
            friendRequestDiv.appendChild(friendRequestP);

            var friendRequestAcceptButton = document.createElement('button');
            friendRequestAcceptButton.textContent = 'Accepter';
            friendRequestDiv.appendChild(friendRequestAcceptButton);

            var friendRequestDeclineButton = document.createElement('button');
            friendRequestDeclineButton.textContent = 'Refuser';
            friendRequestDiv.appendChild(friendRequestDeclineButton);

            var friendRequestBlockedButton = document.createElement('button');
            friendRequestBlockedButton.textContent = 'Bloquer';
            friendRequestDiv.appendChild(friendRequestBlockedButton);

            friendRequestAcceptButton.addEventListener('click', function(event)
            {
                var original_user = event.target.parentElement.firstChild.textContent;
                send_accept_friend_request(original_user, currentUser);
            });

            friendRequestDeclineButton.addEventListener('click', function(event)
            {
                var original_user = event.target.parentElement.firstChild.textContent;
                send_reject_friend_request(original_user, currentUser);
            });

            friendRequestBlockedButton.addEventListener('click', function(event)
            {
                var original_user = event.target.parentElement.firstChild.textContent;
                //SEND BLOCK FRIEND REQUEST
            });
            console.log('Le nom de la div est -->' + friendRequestDiv.id)

        }


        //--------------------------------------------------------------------------------
        //                           Affichage des requetes d'amis
        //--------------------------------------------------------------------------------
        
        

        

        //--------------------------------------------------------------------------------
        //                           Gestion des messages system
        //--------------------------------------------------------------------------------
        socket.onmessage = function(event)
        {
            var data = event.data;
            data = JSON.parse(data);

            console.log('‚úÖ COMMAND:' + data.message.command);
            console.log('‚úÖ USER_TO_ADD' + data.message.user_to_add);
            console.log('‚úÖ ORIGINAL_USER' + data.message.original_user);
            if (data.message.command == undefined || data.message.user_to_add == undefined)
            {
                console.log(data);
            }

            if (data.message.command == 'get_friends_infos' && data.message.user_to_add == currentUser)
            {
                friends = data.message.friends;
                friends_requests = data.message.friend_request;
                console.log('Information sur les amis recues');
                display_friends_requests();
                console.log('friends -->' + friends);
                console.log('friends_requests -->' + friends_requests);
                display_friends();
            }

            if (data.message.command == 'friend_accepted' && data.message.user_to_add == currentUser)
            {
                original_user = data.message.original_user;
                console.log('Requete d\'ami acceptee');
                clear_friend_request(original_user);
                display_friends_div(original_user);
            }

            if (data.message.command == 'friend_rejected' && data.message.user_to_add == currentUser)
            {
                original_user = data.message.original_user;
                console.log('Requete d\'ami refusee');
                clear_friend_request(original_user);
            }

            if (data.message.command == 'friend_deleted' && data.message.original_user == currentUser)
            {
                friend_to_delete = data.message.friend_to_delete;
                console.log('Ami supprime');
                clear_friend(friend_to_delete);
            }

            if (data.message.command == 'add_friend' && data.message.user_to_add == currentUser)
            {
                original_user = data.message.original_user;
                console.log('Requete d\'ami recue');
                display_friend_request_div(original_user);
            }
        }
    </script>
{% endif %}
</html>