<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat en temps r√©el</title>
    <div id="currentUser" style="display: none;">{{ user.username }}</div>
    <script>
        // Connexion WebSocket avec le serveur
        var socket = new WebSocket('wss://localhost/ws/chat/');
        var socket2 = new WebSocket('wss://localhost/ws/system/');

        // √âcoute des √©v√©nements de la connexion WebSocket
        socket.onopen = function(event) {
            console.log('Connexion au chat √©tablie');
        
            socket2.onopen = function(event) {
                console.log('Connexion au system √©tablie');
                send_get_friends_infos(currentUser);
            };
        };

        socket.onclose = function(event) {
            console.log('Connexion au chat ferm√©e');
        };

        socket2.onclose = function(event) {
            console.log('Connexion au system ferm√©e');
        };
    </script>
</head>
<body>
    <h1>Chat en temps r√©el</h1>

    <div id="chat-messages">
        {% if message %}
            {% for msg in message %}
                <div>
                    <p class="user_timestamp_button">
                        <span class="msg_user">{{ msg.user }}</span> | {{ msg.timestamp }}
                        <span id="database_check_add_friend_button-{{forloop.counter}}"</span>
                    </p>
                    <p>{{msg.content}}</p>
                </div>
            {% endfor %}
        {% else %}
            <div id="no-messages">Aucun message pour le moment</div>
        {% endif %}
    </div>

    <form id="chat-form" method="post">
        {% csrf_token %}
        <input type="text" id="message-input" placeholder="Entrez votre message... üî±" autocomplete="off">
        <button type="submit">Envoyer ‚úÖ</button>
    </form>

    <script>
        //GLOBAL VARIABLES
        var friends = [];
        var currentUser = document.getElementById('currentUser').textContent;

        // √âcoute de l'√©v√©nement de soumission du formulaire
        document.querySelector('#chat-form').addEventListener('submit', function(event) {
            // Emp√™che le comportement par d√©faut du formulaire (rechargement de la page)
            event.preventDefault();

            // R√©cup√®re le contenu du champ de texte
            var messageInput = document.querySelector('#message-input');
            var messageContent = messageInput.value;

            // Envoie le message au serveur via WebSocket
            socket.send(JSON.stringify({
                'type': 'send_message',
                'message': messageContent
            }));

            // Efface le champ de texte apr√®s l'envoi du message
            messageInput.value = '';
        });

        function send_get_friends_infos(currentUser)
        {
            var message = {
                'command': 'get_friends_infos',
                'user_to_add': currentUser
            }

            var messageJson = JSON.stringify(message);
            socket2.send(messageJson);
            console.log("Demande d'infos sur les amis envoy√©e");
        }

        // Fonction pour afficher les messages re√ßus
        function displayMessage(messageData) {

            var messageElement = document.createElement('div');
            var userTimestampElement = document.createElement('p');
            var messageContentElement = document.createElement('p');
            var addFriendButton = document.createElement('button');
            var container = document.createElement('div');
            
            container.style.display = 'flex'
            

            userTimestampElement.textContent = messageData.username + ' | ' + messageData.timestamp;
            messageContentElement.textContent = messageData.message;

            container.appendChild(userTimestampElement);
            send_get_friends_infos(currentUser);
            if (messageData.username != currentUser && messageData.username.includes(friends) == false)
            {
                addFriendButton.textContent = 'Ajouter en ami';
                addFriendButton.dataset.username = messageData.username;
                addFriendButton.className = 'add_friend_button';

                container.appendChild(addFriendButton);
            }

            messageElement.appendChild(container);
            messageElement.appendChild(messageContentElement);

            document.querySelector('#chat-messages').appendChild(messageElement);

            addFriendButton.addEventListener('click', function(event) {
                var username = event.target.dataset.username;
                socket2.send(JSON.stringify({
                    'command': 'add_friend',
                    'original_user': currentUser,
                    'user_to_add' : messageData.username,
                }));
            });
        }

        
        // Creation de Bouton pour le moment ou l'on check la database
        var msg_user = document.getElementsByClassName('msg_user');
        for (var i = 0; i < msg_user.length; i++)
        {
            if (msg_user[i].textContent != currentUser && friends.includes(msg_user[i].textContent) == false)
            {
                var username = msg_user[i].textContent;
                if (username != currentUser)
                {
                    var addFriendButton = document.createElement('button');
                    addFriendButton.textContent = 'Ajouter en ami';
                    addFriendButton.dataset.username = username;
                    
                    var friendButtonContainer = document.getElementById('database_check_add_friend_button-' + (i + 1));
                    friendButtonContainer.appendChild(addFriendButton);
                }
            }
        }


        document.addEventListener('DOMContentLoaded', function() {
            var addFriendButtons = document.querySelectorAll('.add_friend_button');

            addFriendButtons.forEach(function(addFriendButton) {
                addFriendButton.addEventListener('click', function(event) {
                    var username = event.target.dataset.username;
                    socket2.send(JSON.stringify({
                        'command': 'add_friend',
                        'original_user': currentUser,
                        'user_to_add' : username,
                    }));
                });
            });
        });

        // √âcoute des messages re√ßus via WebSocket
        socket.onmessage = function(event) {
            var messageData = JSON.parse(event.data);

            var noMessagesDiv = document.getElementById('no-messages');
            if (noMessagesDiv) {
                noMessagesDiv.remove();
            }
            displayMessage(messageData);
        };

        socket2.onmessage = function(event)
        {
            var data = event.data;
            data = JSON.parse(data);
            console.log(data)
            
            if (data.message.user_to_add === currentUser && data.message.command === "get_friends_infos")
            {
                friends = data.friends;
                console.log("infos sur les amis re√ßues");
            }
            else
            {
                console.log("Commande: " + data.message.command + " non reconnue");
            }
        };
    </script>
</body>
</html>
